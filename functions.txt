================================================================================
MEDIA LINKS EXTENSION - FUNCTION REFERENCE
Version: 0.856
================================================================================

This file documents all JavaScript functions in the Media Links extension.
Last updated: January 11, 2026

BUG REVIEW (January 11, 2026):
- Code review completed across all major files
- Found 1 dead code issue in bookmarklets.js (see below)
- Found 1 potential type inconsistency in monkey.js (see below)
- All other major files (stopwatch.js, settings.js, background.js, content.js,
  search.js) have proper validation and error handling

POTENTIAL ISSUES FOUND:

1. bookmarklets.js - Dead code in extractSelector() (lines 291-292)
   The following lines in the extractSelector function are no-ops:
     if (char === '"' && quoteChar === "'") depth += 0; // ignore
     if (char === "'" && quoteChar === '"') depth += 0; // ignore
   Adding 0 to depth does nothing. Either remove these lines or implement
   actual depth tracking if nested quote handling is needed.
   Impact: Low (code works but has dead/useless statements)

2. monkey.js - isBlobUrlAvailable() returns mixed types (lines 139-183)
   This function can return either a boolean (cached value) or a Promise.
   - Line 139-141: Returns cached boolean value
   - Line 153-183: Returns Promise<boolean>
   Callers must handle both cases. The execute() function uses it correctly
   but direct callers should be aware of this.
   Impact: Low (currently handled correctly in usage)

RECENT CHANGES:
- Sidebar UI Redesign (January 11, 2026):
  - Modernized sidebar layout for less cluttered appearance on IMDb pages
  - Links now use a 2-column grid layout instead of single column
  - More compact design: smaller padding, fonts, and spacing
  - Removed circle bullet points in favor of cleaner centered text
  - Active links now use gradient background with glow effect
  - Added subtle border highlight on hover
  - Reduced header size (1.5rem vs 2.5rem) for better space efficiency
  - Compact tabs with smaller font (0.7rem) and tighter spacing
  - Updated cat themes to work with new compact grid layout
  - Cat paw icons repositioned as small absolute elements
  - Fixed Search/Settings buttons: removed permanent purple background
  - Search and Settings now only highlight on hover (text turns accent color)
  - Removed JS code that was adding active class to Search button
  - Fixed IMDb URL detection to handle language prefixes (e.g., /de/title/tt123/)
  - Now uses regex `/\/title\/(tt\d+)/` instead of fixed path position

- Sidebar Bookmarklet Runner (January 11, 2026):
  - Added quick dropdown in sidebar to run bookmarklets on any page
  - Select from saved custom bookmarklets and run with one click
  - Visual feedback (checkmark/X) for execution success/failure
  - Dropdown refreshes automatically when bookmarklets are added/removed
  - New CSS: .bookmarklet-runner, .bookmarklet-dropdown, .run-btn

- Stopwatch Custom Bookmarklet Integration (January 11, 2026):
  - Select custom bookmarklets (from editor) to run on timer expiry
  - Global bookmarklets: Run on ALL domains when any timer fires
  - New storage key: stopwatchGlobalBookmarklets (array of bookmarklet IDs)
  - Settings UI: Checklist in stopwatch settings to select global bookmarklets
  - Execution via MediaLinksBookmarklets.executeMultiple() in content script

- Added Bookmarklet Editor & Scheduler feature (January 11, 2026):
  - New bookmarklet-editor/ folder with dedicated editor page
  - Create, edit, and manage custom JavaScript bookmarklets
  - Import bookmarklets from browser bookmarks
  - Schedule execution: one-time, recurring (daily/weekly), per-domain, interval
  - Auto-run or confirmation dialog per bookmarklet
  - Uses chrome.alarms API for scheduling
  - Domain triggers via content script for page-load/URL-change execution
  - Track execution history and statistics
  - Access via Settings > JS Bookmarklets section

- Fixed false positive success in trustedTypes execution on sites with strict CSP:
  - isEvalAvailable() now checks for Trusted Types presence
  - Sites with Trusted Types typically have strict CSP that blocks eval
  - This prevents trustedTypes method from being tried when it would fail
  - On TT sites, only 'background' method is now used (chrome.scripting API)
  - Fixes CSP console errors that appeared even with pre-filtering

PREVIOUS CHANGES:
- Search feature bug fix: selectedEngine now defaults to 'google' if empty (line 577)
- Note: Pattern Settings UI already exists in settings.html (Query Patterns section)
  - Uses same storage key 'profileSettings' as search.js
  - Access via ⚙️ button in search page header

- Fixed CSP console errors in monkey.js on YouTube and other strict CSP sites:
  - isScriptInjectionAvailable() now checks known strict CSP sites FIRST before
    any other detection methods (works across all browsers including Brave)
  - isEvalAvailable() also checks strict CSP sites first AND Trusted Types presence
  - execute() now pre-checks method availability before attempting execution,
    filtering out methods that would trigger CSP errors
  - Added 'available' property to method definitions in execute()
  - Methods with available=false are filtered out before trying them
  - This prevents CSP violation errors from appearing in browser console
  - Strict CSP sites list: youtube.com, www.youtube.com, music.youtube.com,
    google.com, www.google.com
  - Additional bug fixes found during review:
    - blobUrl method now marked unavailable on strict CSP (blob: not in script-src)
    - trustedTypes method requires evalAvailable (uses eval internally)
    - iframe method marked unavailable on strict CSP (inherits parent CSP with
      allow-same-origin sandbox attribute)
    - On strict CSP sites, only 'background' method is used (chrome.scripting API)

PREVIOUS CHANGES:
- Added per-domain notification time support for stopwatch. Each domain can now have
  its own notification time instead of a single global time for all domains.
  - New setting: stopwatchNotificationTimeByDomain (object mapping domains to seconds)
  - Time format supports MM:SS (e.g., "11:11" = 11 minutes 11 seconds = 671 seconds)
  - Falls back to global stopwatchNotificationMinutes if no per-domain time is set
  - Domain matching supports wildcards: *.domain.com, domain.*, *keyword*

- Updated settings.js with new helper functions:
  - parseNotificationTimeByDomain(): Parses JSON object of domain notification times
  - formatSecondsToMMSS(): Formats seconds to MM:SS display (e.g., 671 -> "11:11")
  - parseMMSSToSeconds(): Parses MM:SS string to seconds (e.g., "11:11" -> 671)

- Updated stopwatch.js with new function:
  - getNotificationTimeForCurrentDomain(): Returns notification time in seconds
    for the current domain, with wildcard pattern matching support

BUG FIXES (January 6, 2026):
- Fixed domain matching logic in getNotificationTimeForCurrentDomain() and
  getBookmarksForCurrentDomain() - removed incorrect third condition that would
  match when pattern was a subdomain of current hostname (backwards logic)
- Fixed formatSecondsToMMSS() to properly handle 0 seconds (was returning empty
  string due to falsy check on 0)
- Fixed save handler in domain config modal - entering "0" or "0:00" now properly
  clears the custom time (uses default) instead of showing confusing error message

UI IMPROVEMENTS (January 6, 2026):
- Added bookmark search in domain configuration modal - search by title or URL
  - Search input filters bookmark tree in real-time
  - Shows matching bookmarks and their parent folders
  - Data attributes added to bookmark items for filtering (data-bookmark-title,
    data-bookmark-url, data-folder, data-folder-children)
- Improved responsive design for settings page:
  - Added @media query for extra small screens (< 480px)
  - Better spacing and sizing for mobile devices
  - Modal now takes 95% width with proper margins
  - Improved touch targets for buttons
  - Domain input row stacks vertically on small screens
  - Consistent padding across all modal sections
- Stopwatch is now draggable with edge snapping:
  - Drag the stopwatch anywhere on screen with mouse
  - Automatically snaps to screen edges (20px threshold)
  - Position is saved to storage and persists across page loads
  - New setting: stopwatchCustomPosition (object with x, y coordinates)
  - "Reset to Default" button in settings to restore bottom-right position
  - Replaced position dropdown with drag instructions
  - New functions in stopwatch.js:
    - snapToEdge(): Snaps position to nearest screen edge
    - constrainToViewport(): Keeps stopwatch within screen bounds
    - saveCustomPosition(): Persists position to chrome.storage
    - handleDragStart/Move/End(): Mouse drag event handlers
    - setupDragHandlers(): Initializes drag functionality

PREVIOUS CHANGES:
- Created monkey.js - Dedicated script injection engine inspired by Tampermonkey
  and Violentmonkey. Provides 7 execution methods to bypass CSP and Trusted Types:
  1. Script tag injection (MAIN world)
  2. Blob URL injection (bypasses inline CSP)
  3. Trusted Types policy (for sites like YouTube)
  4. eval/Function constructor
  5. Shadow DOM injection
  6. Sandboxed iframe
  7. Background execution via chrome.scripting.executeScript

- bookmarklets.js now uses MonkeyEngine for all script execution, providing
  better compatibility with sites that have strict Content Security Policies.

- Added userScripts API support for CSP-exempt bookmarklet execution. Sites like
  YouTube have strict CSP that blocks script injection and eval. The userScripts
  API provides a USER_SCRIPT execution world that is explicitly exempt from page
  CSP. Note: Brave browser disables this API for security reasons.

- Fixed stopwatch settings persistence bug where included domains and bookmarks
  would disappear after saving. The issue was a race condition in applySettingsToUI()
  where renderDomainTags() was called BEFORE the bookmarks hidden input was populated.
  Now bookmarksByDomain is populated before rendering the domain list.

- Added bookmarklet support for stopwatch notifications. When a bookmark has a
  javascript: URL, it now executes via chrome.scripting.executeScript() in the
  current tab's page context (world: 'MAIN') instead of trying to open it as a
  URL (which Chrome blocks for security).

- Created dedicated bookmarklets.js for handling all bookmarklet execution.
  Exposes MediaLinksBookmarklets API for enterprise-safe execution:
  - Uses isolated world new Function() - allowed by extension CSP
  - Has full DOM access (click buttons, check checkboxes, extract data)
  - Falls back to userScripts API for CSP-exempt execution
  - stopwatch.js now uses this API instead of inline execution
  Regular bookmarks still use background script for chrome.tabs.create().

================================================================================
CORE EXTENSION FILES
================================================================================

--------------------------------------------------------------------------------
content.js - Main content script for page interactions
--------------------------------------------------------------------------------

sendSelectionUpdate(text, fromContextMenu)
  - Safely sends selected text updates to background script

createCopyModal()
  - Creates modal for selecting tabs to copy content from

showCopyFeedback(success)
  - Shows success/error feedback on copy button

createCopyWebpageButton()
  - Creates the floating copy button on pages

removeCopyWebpageButton()
  - Removes the copy button from the page

updateCopyWebpageButton(shouldShow)
  - Shows or hides copy button based on settings

initCopyWebpageButton()
  - Initializes button based on user settings

Message Handler:
  - copyPageContent: Selects all page content and returns it for multi-tab copying

Event Listeners:
  - mouseup: Sends selection to background script
  - keyup (Shift): Sends keyboard-based selection
  - contextmenu: Sends selection immediately for context menu
  - selectionchange: Debounced selection update (150ms)

--------------------------------------------------------------------------------
background.js - Background service worker
--------------------------------------------------------------------------------

generateUUID()
  - Generates unique identifiers for storage operations

configureUserScriptsWorld()
  - Configures the userScripts world for bookmarklet execution
  - Sets permissive CSP and enables messaging
  - The USER_SCRIPT world is exempt from page CSP

executeBookmarkletInTab(tabId, code, title)
  - Executes a bookmarklet in the specified tab using userScripts API
  - Tries chrome.userScripts.execute() first (Chrome 135+, CSP-exempt)
  - Falls back to chrome.scripting.executeScript with MAIN world
  - Parameters: tabId (number), code (string), title (string)
  - Returns: Promise<{success: boolean, error?: string}>

createOffscreenDocument()
  - Creates offscreen document for OCR processing

extractIMDbId(url)
  - Extracts IMDb ID from URLs

extractConsolidatedIMDbData(imdbId, sendProgress)
  - Opens and extracts data from all IMDb pages (cast, crew, awards, etc.)

extractWikipediaData(tabId)
  - Extracts data from Wikipedia pages

compareData(wikipediaData, imdbData)
  - Compares data between two sources with conflict detection

broadcastThemeChange(theme)
  - Broadcasts theme changes to all open pages

updateContextMenu(selectionText, immediate)
  - Updates context menu with search options based on selection

Message Handlers:
  - createTab: Creates new tabs for data extraction
  - closeConsolidatedViewTab: Closes tabs created for consolidation
  - closeTab: Closes specific tabs
  - getTabStatus: Gets tab loading status
  - focusTab: Makes a tab active
  - sendExtractionMessage: Relays extraction message to target tab
  - getTabs: Returns list of open tabs
  - queryTabs: Filters tabs for comparison feature
  - updateTab: Updates tab URL
  - startComparison: Initiates comparison workflow
  - copyMultipleTabs: Gathers content from multiple tabs
  - getCurrentTabId: Returns sender tab ID
  - openTranscriptView: Opens YouTube transcript view page
  - focusCurrentTab: Focuses current tab and window (for stopwatch notifications)
  - openBookmarks: Opens regular URL bookmarks in new tabs (for stopwatch notifications)
    - Bookmarklets (javascript: URLs) are handled directly by stopwatch.js content script
    - Only processes regular http/https URLs
    - Opens first bookmark as active tab, rest in background
  - executeBookmarklet: Executes a single bookmarklet via userScripts API
    - Uses chrome.userScripts.execute() which is exempt from page CSP
    - Falls back to chrome.scripting.executeScript with MAIN world
    - Parameters: { code, title }
    - Returns: { success, error? }
  - executeMultipleBookmarklets: Batch executes multiple bookmarklets
    - Parameters: { bookmarklets: [{code, title}] }
    - Returns: { success, results: {total, executed, failed, errors[]} }
  - performOCR: Forwards OCR requests to offscreen document
  - themeChanged: Broadcasts theme changes
  - selectionChanged: Updates context menu based on text selection

Inner Functions in compareData():
  - normalizeName(name): Normalizes names for comparison (removes periods, apostrophes)
  - compareLists(listA, listB, nameField): Compares two lists of items
  - flattenIMDbData(imdbData): Flattens IMDb consolidated data into lists
  - consolidateBothSources(wikipediaData, imdbData): Unifies data format from both sources
  - compareListEnhanced(wikiList, imdbList, nameField): Enhanced comparison with conflict detection

Helper Functions:
  - getSearchUrl(query, engine): Generates search URL for query
  - getCombinations(elements, size): Generates all combinations of elements
  - generateQueries(words, profileSettings): Generates search queries from words
  - sanitizeForContextMenu(text): Sanitizes text for context menu display
  - addPendingUpdate(textToUpdate): Adds update to pending queue
  - processPendingUpdate(): Processes pending context menu updates

--------------------------------------------------------------------------------
sidebar.js - Sidebar panel management
--------------------------------------------------------------------------------

createLink(url, text)
  - Creates navigation links for sidebar

addLinks(links)
  - Adds multiple links to sidebar

getLinksForIMDb(imdbId)
  - Gets IMDb navigation links (Main, Cast, Production, Awards, etc.)

getLinksForLetterboxd(filmName)
  - Gets Letterboxd navigation links

setActiveLink()
  - Highlights current page link

updateLinks()
  - Updates links based on current page

init()
  - Initializes sidebar with event listeners

loadBookmarkletDropdown()
  - Loads custom bookmarklets from storage and populates dropdown
  - Filters to enabled bookmarklets only, sorted alphabetically

runSelectedBookmarklet()
  - Executes selected bookmarklet in current active tab
  - Uses chrome.runtime.sendMessage with type 'runBookmarkletInActiveTab'
  - Shows visual feedback on success/failure

showRunResult(btn, originalText, success)
  - Shows visual feedback on run button (checkmark or X)
  - Reverts to original state after 1 second

initBookmarkletRunner()
  - Initializes dropdown, run button, and storage change listener
  - Called from init()

--------------------------------------------------------------------------------
bookmarklets.js - Bookmarklet execution handler
--------------------------------------------------------------------------------

Exposes: window.MediaLinksBookmarklets API

For enterprise environments with strict CSP that blocks eval/new Function,
this module uses multiple fallback methods including background script execution
via the userScripts API (which is exempt from page CSP).

WHY ADDRESS BAR / PROGRAMMATIC NAVIGATION DOESN'T WORK:
Chrome blocks ALL programmatic navigation to javascript: URLs for security:
  - window.location.href = "javascript:..." → BLOCKED
  - window.location.assign("javascript:...") → BLOCKED
  - chrome.tabs.update({url: "javascript:..."}) → BLOCKED
  - window.open("javascript:...") → BLOCKED
  - Creating <a href="javascript:..."> and clicking → BLOCKED
These restrictions prevent XSS attacks.

SOLUTION: MULTIPLE EXECUTION METHODS
The module tries multiple methods in order to execute bookmarklets:

EXECUTION PRIORITY (4 methods, in order):
  1. Script injection (MAIN world) - Full page JS access, like Tampermonkey
  2. eval/new Function (isolated world) - DOM access only, no page JS
  3. Background execution (userScripts API) - CSP-exempt, full JS execution
  4. Action parsing (enterprise fallback) - Parse into DOM actions

The userScripts API (Chrome 135+) provides a USER_SCRIPT execution world that
is explicitly exempt from page CSP, allowing bookmarklets to run even on sites
with strict security policies like YouTube.

BOOKMARKLET EXECUTION:

MediaLinksBookmarklets.execute(jsCode, title)
  - Tries script injection, then eval, then background, then action parsing
  - Returns: Promise<boolean> (true if succeeded)

MediaLinksBookmarklets.executeFromUrl(bookmark)
  - Executes a bookmarklet from bookmark object with url and title properties
  - Parses javascript: URL and executes the code
  - Returns: Promise<boolean> (true if succeeded)

MediaLinksBookmarklets.executeMultiple(bookmarks)
  - Executes multiple bookmarklets sequentially
  - Filters array to only process javascript: URLs
  - Uses batch background execution when local methods unavailable
  - Returns: Promise<{ total, executed, failed, errors[] }>

MediaLinksBookmarklets.parse(bookmarkletUrl)
  - Parses a javascript: URL and returns the decoded JavaScript code
  - Handles double/triple encoded bookmarklets (decodes up to 3 times)
  - Returns: string (decoded code) or null if invalid

MediaLinksBookmarklets.isBookmarklet(url)
  - Checks if a URL is a bookmarklet (starts with javascript:)
  - Returns: boolean

SCRIPT INJECTION (Tampermonkey-style, MAIN world):

MediaLinksBookmarklets.executeInPageContext(jsCode)
  - Executes JavaScript via script tag injection (like Tampermonkey)
  - Runs in page's MAIN world with full access to page JS functions
  - Returns: boolean (true if succeeded)

MediaLinksBookmarklets.isScriptInjectionAvailable()
  - Checks if script tag injection is available (not blocked by CSP)
  - Returns: boolean

BACKGROUND EXECUTION (userScripts API - CSP Exempt):

MediaLinksBookmarklets.executeViaBackground(jsCode, title)
  - Sends bookmarklet to background script for execution via userScripts API
  - The USER_SCRIPT world is exempt from page CSP
  - Returns: Promise<boolean> (true if succeeded)

MediaLinksBookmarklets.executeMultipleViaBackground(bookmarklets)
  - Batch execution of multiple bookmarklets via background script
  - Parameter: Array of { code, title } objects
  - Returns: Promise<{ total, executed, failed, errors[] }>

DOM ACTIONS (Enterprise-Safe - No eval needed):

MediaLinksBookmarklets.action(actionConfig)
  - Executes a DOM action without eval (works even when CSP blocks eval)
  - Supported action types:
    - check: Check checkbox(es) matching selector
    - uncheck: Uncheck checkbox(es) matching selector
    - click: Click element(s) matching selector
    - setValue: Set value of input(s) matching selector
    - focus: Focus element matching selector
    - getText: Get text content of element
    - hasText: Check if page contains text
    - alert: Show an alert message
  - Config: { type, selector, value, all }
  - Returns: { success, error?, elementsModified?, text?, found? }

MediaLinksBookmarklets.parseToActions(jsCode)
  - Parses bookmarklet code into DOM actions
  - Recognizes common patterns: querySelector, checked, value, click, alert
  - Returns: array of action configs

MediaLinksBookmarklets.isEvalAvailable()
  - Checks if eval/new Function is available (not blocked by CSP)
  - Returns: boolean

MediaLinksBookmarklets.isExtensionContextValid()
  - Checks if extension context is valid for messaging background script
  - Returns: boolean

MediaLinksBookmarklets.getEngine()
  - Returns the MonkeyEngine instance if available
  - Returns: MonkeyEngine | undefined

--------------------------------------------------------------------------------
monkey.js - Script Injection Engine (CSP/Trusted Types Bypass)
--------------------------------------------------------------------------------

Exposes: window.MonkeyEngine API

A dedicated script injection engine inspired by Tampermonkey, Violentmonkey,
and ScriptCat. Provides multiple methods to execute JavaScript code in web
pages, bypassing Content Security Policy (CSP) and Trusted Types restrictions.

WHY THIS EXISTS:
Modern websites like YouTube enforce strict CSP and Trusted Types policies that
block traditional script execution methods. MonkeyEngine provides 9 different
execution strategies, trying each in order until one succeeds.

SCRIPTCAT-STYLE FEATURES:
- Context injection via `with()` statement - inject custom APIs/variables
- Top-level await support via async IIFE wrapper
- SourceURL for debugging in DevTools
- GM-style API injection (GM_setValue, GM_getValue, etc.)
- Better error handling with script name in stack traces
- Timer isolation for script cleanup
- Property listener for script detection
- Performance API messaging (CSP bypass)
- Event handler interception for sandbox compatibility

TAMPERMONKEY-STYLE FEATURES:
- Vault pattern - preserve native APIs before page can override them
- Shadow DOM + iframe isolation for maximum isolation
- ACK-based reliable messaging with timeout handling
- Nonce detection and reuse

EXECUTION METHODS (in order of preference):
1. Script tag injection - MAIN world, full page JS access
2. Blob URL injection - Creates external script source, bypasses inline CSP
3. Trusted Types policy - Creates policy for sites enforcing Trusted Types
4. Compiled Context (ScriptCat-style) - with() context, async support, sourceURL
5. eval/Function - Isolated world, uses ScriptCat compilation
6. Shadow DOM - Isolated container for script execution
7. Shadow DOM + iframe - Maximum isolation (Tampermonkey-style)
8. Sandboxed iframe - Iframe with minimal permissions
9. Background execution - chrome.scripting.executeScript with MAIN world

MAIN EXECUTION API:

MonkeyEngine.execute(code, options)
  - Executes code using all available methods (auto-fallback)
  - Parameters:
    - code: JavaScript code to execute
    - options.title: Script title for logging
    - options.nonce: CSP nonce to use
    - options.preferredMethod: Try this method first
    - options.skipMethods: Array of methods to skip
    - options.context: Custom context object for variable injection
    - options.apis: Custom APIs to inject (e.g., { myFunc: () => {} })
    - options.variables: Custom variables to inject
  - Returns: Promise<{success: boolean, method: string, error?: string}>

MonkeyEngine.executeMultiple(scripts, options)
  - Executes multiple scripts sequentially with auto-fallback
  - Parameters:
    - scripts: Array of {code, title} objects
    - options: Same as execute()
  - Returns: Promise<{total, executed, failed, errors, results}>

SCRIPTCAT-STYLE EXECUTION:

MonkeyEngine.executeWithContext(code, options)
  - Executes script with context injection (ScriptCat-style)
  - Supports top-level await and custom API injection
  - Parameters:
    - code: JavaScript code to execute
    - options.title: Script title for debugging
    - options.context: Custom context object (or one will be created)
    - options.apis: Custom APIs to inject into context
    - options.variables: Custom variables to inject into context
    - options.useGMContext: Create a GM-style context (default: false)
    - options.requireCode: Pre-loaded dependencies code
  - Returns: Promise<{success: boolean, method: string, result?: any, error?: string}>
  - Example:
      MonkeyEngine.executeWithContext(`
        const data = await fetch('/api/data').then(r => r.json());
        myCustomAPI(data);
      `, {
        title: 'My Script',
        apis: { myCustomAPI: (d) => console.log(d) }
      });

MonkeyEngine.compileScript(code, title, requireCode)
  - Compiles script code into an executable function (ScriptCat-style)
  - Wraps code with: with() block, async IIFE, try-catch, sourceURL
  - Parameters:
    - code: JavaScript code to compile
    - title: Script title for debugging (default: 'Script')
    - requireCode: Optional pre-loaded dependencies
  - Returns: Function ready for execution with .call(context, context, title)

MonkeyEngine.createContext(options)
  - Creates a sandbox context with custom APIs
  - Parameters:
    - options.apis: Custom APIs to inject (e.g., GM_setValue, GM_getValue)
    - options.variables: Custom variables to inject
    - options.exposeWindow: Whether to expose unsafeWindow (default: true)
    - options.exposeDocument: Whether to expose document reference (default: true)
  - Returns: Context object for script execution

MonkeyEngine.createGMContext(scriptName, storage)
  - Creates a GM-style API context with Tampermonkey-like APIs
  - Parameters:
    - scriptName: Name of the script for GM_info
    - storage: Optional storage object for GM_setValue/getValue (default: in-memory)
  - Returns: Context with GM-style APIs
  - Included APIs:
    - GM_info / GM.info - Script information
    - GM_setValue / GM.setValue - Store value
    - GM_getValue / GM.getValue - Retrieve value
    - GM_deleteValue / GM.deleteValue - Delete value
    - GM_listValues / GM.listValues - List all keys
    - GM_log / GM.log - Console logging with script name prefix
    - GM_setClipboard / GM.setClipboard - Copy to clipboard
    - GM_notification / GM.notification - Show notification (basic alert)
    - GM_openInTab / GM.openInTab - Open URL in new tab
    - GM_addStyle / GM.addStyle - Add CSS to page
    - GM_xmlhttpRequest / GM.xmlHttpRequest - XHR wrapper (same-origin only)

INDIVIDUAL EXECUTION METHODS:

MonkeyEngine.executeViaScriptTag(code, options)
  - Executes via script tag injection (MAIN world)
  - Options: { nonce: string }
  - Returns: {success: boolean, method: 'scriptTag', error?: string}

MonkeyEngine.executeViaBlobUrl(code, options)
  - Executes via Blob URL (bypasses inline CSP)
  - Options: { nonce: string }
  - Returns: Promise<{success: boolean, method: 'blobUrl', error?: string}>

MonkeyEngine.executeViaTrustedTypes(code, options)
  - Executes using Trusted Types policy
  - Options: { policyName: string }
  - Returns: {success: boolean, method: 'trustedTypes', error?: string}

MonkeyEngine.executeViaEval(code, options)
  - Executes via eval/Function constructor (uses ScriptCat-style compilation)
  - Supports context injection and async scripts
  - Options: { title, context, apis, variables }
  - Returns: {success: boolean, method: 'eval', error?: string}

MonkeyEngine.executeViaEvalSimple(code, options)
  - Legacy eval execution without ScriptCat features
  - Use this if you need simple execution without async wrapper
  - Returns: {success: boolean, method: 'evalSimple', error?: string}

MonkeyEngine.executeViaShadowDom(code, options)
  - Executes via Shadow DOM isolation
  - Options: { nonce: string }
  - Returns: {success: boolean, method: 'shadowDom', error?: string}

MonkeyEngine.executeViaShadowIframe(code, options)
  - Executes via Shadow DOM + iframe isolation (Tampermonkey-style)
  - Creates closed shadow DOM with sandboxed iframe for maximum isolation
  - Uses vault for DOM operations to prevent page tampering
  - Options: { nonce: string, title: string }
  - Returns: Promise<{success: boolean, method: 'shadowIframe', error?: string}>

MonkeyEngine.executeViaIframe(code, options)
  - Executes via sandboxed iframe
  - Options: { shareWindow: boolean (default true) }
  - Returns: Promise<{success: boolean, method: 'iframe', error?: string}>

MonkeyEngine.executeViaBackground(code, title)
  - Executes via background script (chrome.scripting.executeScript)
  - Returns: Promise<{success: boolean, method: 'background', error?: string}>

MonkeyEngine.executeMultipleViaBackground(scripts)
  - Batch executes multiple scripts via background
  - Parameters: Array of {code, title} objects
  - Returns: Promise with results object

VAULT - PRESERVED NATIVE APIS (Tampermonkey-style):

MonkeyEngine.vault
  - Object containing preserved native APIs captured before page scripts run
  - Protects against prototype pollution and function hijacking
  - Contains:
    - Constructors: Function, Object, Array, Promise, Error, Proxy, Blob
    - Evaluation: eval
    - Timers: setTimeout, clearTimeout, setInterval, clearInterval (bound)
    - Events: CustomEvent, MouseEvent, Event
    - DOM creation: createElement, createElementNS (bound to document)
    - DOM manipulation: appendChild, removeChild, remove, setAttribute, etc.
    - Events: addEventListener, removeEventListener, dispatchEvent
    - URL: createObjectURL, revokeObjectURL (bound)
    - Selectors: querySelector, querySelectorAll, getElementById
    - Performance API: perfAddEventListener, perfDispatchEvent (bound)
    - JSON: JSONparse, JSONstringify
    - Encoding: btoa, atob, encodeURIComponent, decodeURIComponent

TIMER ISOLATION (ScriptCat-style):

MonkeyEngine.createTimerIsolation()
  - Creates isolated timer manager for a script
  - Tracks all setTimeout/setInterval calls for cleanup
  - Returns: {
      setTimeout(fn, ms, ...args): number,
      setInterval(fn, ms, ...args): number,
      clearTimeout(id): void,
      clearInterval(id): void,
      cleanup(): void,           // Clears all active timers
      getStats(): { timeouts: number, intervals: number }
    }
  - Example:
      const timers = MonkeyEngine.createTimerIsolation();
      timers.setTimeout(() => console.log('Hello'), 1000);
      // Later, cleanup all timers:
      timers.cleanup();

PROPERTY LISTENER (ScriptCat-style):

MonkeyEngine.definePropertyListener(obj, prop, callback)
  - Listen for a property to be set on an object
  - Self-destructs after the property is set
  - Parameters:
    - obj: Object to watch
    - prop: Property name to watch
    - callback: Function called with the value when property is set
  - Example:
      // Detect when a script function is mounted on window
      MonkeyEngine.definePropertyListener(window, '__myScript', (fn) => {
        fn(); // Execute the script
      });

PERFORMANCE API MESSAGING (ScriptCat-style CSP bypass):

MonkeyEngine.perfMessaging
  - Messaging via performance API instead of document (bypasses some CSP)
  - Methods:
    - send(channel, data): void - Send message on channel
    - listen(channel, handler): unsubscribe - Listen for messages, returns unsubscribe fn
    - request(channel, data, timeout?): Promise - Send and wait for response
    - cleanup(): void - Remove all listeners
  - Example:
      // Listen for messages
      const unsub = MonkeyEngine.perfMessaging.listen('myChannel', (data) => {
        console.log('Received:', data);
      });
      // Send message
      MonkeyEngine.perfMessaging.send('myChannel', { hello: 'world' });
      // Cleanup
      unsub();

RELIABLE MESSAGING WITH ACK (Tampermonkey-style):

MonkeyEngine.createReliableMessaging()
  - Creates reliable messaging channel with acknowledgment support
  - Handles timeouts and extension context validation
  - Returns: {
      send(type, data, timeout?): Promise - Send message and wait for response
      handleAck(ackId, response): boolean - Handle ACK response
      getPendingCount(): number - Get pending message count
      cancelAll(): void - Cancel all pending messages
    }
  - Example:
      const messaging = MonkeyEngine.createReliableMessaging();
      try {
        const response = await messaging.send('getData', { id: 123 });
        console.log('Response:', response);
      } catch (e) {
        console.error('Message failed:', e.message);
      }

EVENT HANDLER INTERCEPTION (ScriptCat-style):

MonkeyEngine.createEventInterceptors(context, eventNames?)
  - Create event property descriptors for sandbox context
  - Allows scripts to use window.onload = fn style handlers in sandbox
  - Parameters:
    - context: Sandbox context object
    - eventNames: Array of event names (default: common events)
  - Returns: Property descriptors for Object.defineProperties
  - Example:
      const context = MonkeyEngine.createContext();
      const interceptors = MonkeyEngine.createEventInterceptors(context);
      Object.defineProperties(context, interceptors);
      // Now scripts can use: context.onload = () => { ... }

DETECTION UTILITIES:

MonkeyEngine.detectNonce()
  - Detects CSP nonce from existing page scripts
  - Returns: string | false

MonkeyEngine.isScriptInjectionAvailable()
  - Checks if script tag injection works
  - Returns: boolean

MonkeyEngine.isBlobUrlAvailable()
  - Checks if Blob URL injection works
  - Returns: Promise<boolean>

MonkeyEngine.isTrustedTypesAvailable()
  - Checks if Trusted Types API is available
  - Returns: boolean

MonkeyEngine.isEvalAvailable()
  - Checks if eval/Function is available
  - Returns: boolean

MonkeyEngine.isExtensionContextValid()
  - Checks if extension context is valid for messaging
  - Returns: boolean

STATUS AND CACHE:

MonkeyEngine.getMethodStatus()
  - Returns current method availability status
  - Returns: { scriptInjection, eval, trustedTypes, nonce, extensionContext }

MonkeyEngine.resetCache()
  - Resets cached method availability (useful after page changes)

--------------------------------------------------------------------------------
stopwatch.js - Time tracking on websites
--------------------------------------------------------------------------------

isExtensionContextValid()
  - Checks if extension context is still valid

isDomainIncluded()
  - Checks if current domain is in allowed list (supports wildcards)
  - Includes type validation for robustness

getNotificationTimeForCurrentDomain()
  - Returns notification time in seconds for the current domain
  - Checks exact match first, then partial matches, then wildcards
  - Supports wildcard patterns: *.domain.com, domain.*, *keyword*
  - Falls back to global stopwatchNotificationMinutes * 60 if no per-domain time set
  - Returns: number (time in seconds)

getBookmarksForCurrentDomain()
  - Looks up bookmarks configured for the current website domain
  - Supports wildcard patterns: *.domain.com, domain.*, *keyword*
  - Supports URL patterns with paths: *example.com/path*
  - Checks exact match first, then partial matches (e.g., youtube.com matches www.youtube.com)
  - Matches against full URL when pattern contains a path, otherwise just hostname

openSelectedBookmarks() [async]
  - Opens bookmarks for current domain
  - Called AFTER user clicks "OK" to dismiss the notification alert (not before)
  - Only called if openBookmarksOnNotification is enabled and domain has configured bookmarks
  - Bookmarklets: Handled by bookmarklets.js (MediaLinksBookmarklets.executeMultiple - async)
  - Regular URLs: Sent to background script to open in new tabs
  - Also calls executeCustomBookmarklets() to run global custom bookmarklets

executeCustomBookmarklets() [async]
  - Executes global custom bookmarklets from the bookmarklet editor
  - Fetches bookmarklet code from chrome.storage.local using settings.globalBookmarklets IDs
  - Converts to bookmark format and executes via MediaLinksBookmarklets.executeMultiple()
  - Called from openSelectedBookmarks() after browser bookmarks are processed

formatTime(ms)
  - Formats milliseconds to HH:MM:SS

getPositionStyles()
  - Returns CSS styles based on stopwatch position setting

getThemeColors()
  - Gets theme colors with computed values

loadCurrentTheme()
  - Loads user's selected theme from storage

isColorDark(hexColor)
  - Determines if a color is dark or light
  - Validates hex format, returns true (dark) for invalid colors

lightenColor(hexColor, percent)
  - Lightens a hex color by percentage
  - Validates hex format, returns #ffffff for invalid colors

darkenColor(hexColor, percent)
  - Darkens a hex color by percentage
  - Validates hex format, returns #000000 for invalid colors

createStopwatch()
  - Creates stopwatch UI element

updateStopwatchUI()
  - Updates display (expanded or minimized)

updateTime()
  - Updates time display and checks for notifications

showToastNotification(elapsed)
  - Shows alert notification and focuses tab
  - Flow: 1) Focus tab via background script, 2) Wait 150ms, 3) Show blocking alert()
  - After user clicks "OK" to dismiss alert, calls openSelectedBookmarks() if enabled

start()
  - Starts the stopwatch

stop()
  - Stops and removes stopwatch

loadSettings()
  - Loads stopwatch configuration

init()
  - Initializes stopwatch based on settings

--------------------------------------------------------------------------------
bookmarklet-editor/bookmarkleteditor.js - Bookmarklet Editor UI
--------------------------------------------------------------------------------

init()
  - Initializes editor, caches elements, loads bookmarklets, applies theme

loadBookmarklets()
  - Loads all bookmarklets from storage

renderBookmarkletList(filter)
  - Renders the sidebar list of bookmarklets with optional search filter

selectBookmarklet(id)
  - Selects a bookmarklet for editing, populates form

createNewBookmarklet()
  - Creates a new empty bookmarklet for editing

saveCurrentBookmarklet()
  - Validates and saves current bookmarklet to storage
  - Updates schedule via background script

deleteCurrentBookmarklet()
  - Deletes current bookmarklet and cancels its schedule

duplicateCurrentBookmarklet()
  - Creates a copy of the current bookmarklet

runCurrentBookmarklet()
  - Executes bookmarklet code in current active tab

buildScheduleConfig()
  - Builds schedule configuration object from form inputs

handleScheduleTypeChange()
  - Shows/hides schedule config panels based on selected type

openImportModal()
  - Opens modal to import from browser bookmarks
  - Uses chrome.bookmarks.getTree() to list bookmarklets

importSelectedBookmarks()
  - Imports selected bookmarklets from browser bookmarks

formatCode()
  - Basic JavaScript code formatting

wrapInIife()
  - Wraps code in an IIFE: (function() { ... })();

testCodeSyntax()
  - Tests code syntax using new Function()

--------------------------------------------------------------------------------
bookmarklet-editor/scheduler.js - Scheduling Engine
--------------------------------------------------------------------------------

BookmarkletScheduler.scheduleBookmarklet(bookmarklet)
  - Schedules a bookmarklet based on its schedule configuration
  - Cancels existing alarms first, then creates new ones

BookmarkletScheduler.scheduleOneTime(bookmarkletId, datetime)
  - Creates a one-time chrome.alarm for specified datetime

BookmarkletScheduler.scheduleRecurring(bookmarkletId, config)
  - Creates recurring alarm (daily with periodInMinutes, weekly recreated)

BookmarkletScheduler.scheduleInterval(bookmarkletId, intervalMinutes)
  - Creates interval-based alarm that fires every N minutes

BookmarkletScheduler.cancelSchedule(bookmarkletId)
  - Clears all alarms associated with a bookmarklet

BookmarkletScheduler.handleAlarm(alarm)
  - Handles alarm firing, checks domain filter, executes or shows confirmation

BookmarkletScheduler.executeBookmarklet(bookmarklet)
  - Executes bookmarklet in active tab (auto-run or confirmation)

BookmarkletScheduler.showConfirmationDialog(tabId, bookmarklet)
  - Injects confirmation dialog into tab for non-auto-run bookmarklets

BookmarkletScheduler.calculateNextRun(config)
  - Calculates next run time for recurring schedules

BookmarkletScheduler.initializeSchedules()
  - Initializes all schedules from storage on extension start

--------------------------------------------------------------------------------
bookmarklet-editor/scheduler-storage.js - Storage Utilities
--------------------------------------------------------------------------------

BookmarkletStorage.getAllBookmarklets()
  - Returns all bookmarklets from chrome.storage.local

BookmarkletStorage.getBookmarklet(id)
  - Returns a single bookmarklet by ID

BookmarkletStorage.saveBookmarklet(bookmarklet)
  - Saves a bookmarklet (create or update)

BookmarkletStorage.deleteBookmarklet(id)
  - Deletes a bookmarklet by ID

BookmarkletStorage.updateBookmarkletStats(id)
  - Updates lastExecuted and executionCount

BookmarkletStorage.importFromBrowserBookmarks(bookmarks)
  - Imports javascript: URLs from browser bookmark array

BookmarkletStorage.getScheduledTasks()
  - Returns all scheduled task records

BookmarkletStorage.saveScheduledTask(alarmName, bookmarkletId, nextRun)
  - Saves scheduled task record

BookmarkletStorage.removeScheduledTask(alarmName)
  - Removes scheduled task record

--------------------------------------------------------------------------------
bookmarklet-editor/domain-trigger.js - Domain Trigger Content Script
--------------------------------------------------------------------------------

checkDomainTriggers(trigger)
  - Checks for domain-triggered bookmarklets on pageload or urlchange
  - Executes matching bookmarklets (auto-run or confirmation)

matchesPattern(pattern)
  - Checks if current URL matches a domain pattern
  - Supports wildcards: *.domain.com, domain.*, *keyword*

executeBookmarklet(bookmarklet)
  - Executes bookmarklet code, uses MediaLinksBookmarklets if available

showConfirmationDialog(bookmarklet)
  - Shows themed confirmation dialog before execution

showNotification(name, status, errorMsg)
  - Shows toast notification after execution

updateStats(bookmarkletId)
  - Updates bookmarklet execution statistics

setupUrlMonitor()
  - Monitors URL changes for SPA navigation (pushState, popstate)

--------------------------------------------------------------------------------
settings.js - Extension settings management
--------------------------------------------------------------------------------

getDefaultSettings()
  - Returns default settings object

loadSettings()
  - Loads settings from storage asynchronously

applySettingsToUI()
  - Updates UI with loaded settings

applyTheme(theme)
  - Applies theme to document

attachEventListeners()
  - Binds all form event handlers

markUnsaved()
  - Flags unsaved changes

toggleComparisonSettings(enabled)
  - Shows/hides comparison settings subsection

toggleStopwatchSettings(enabled)
  - Shows/hides stopwatch settings subsection

toggleNotificationMinutes(enabled)
  - Shows/hides notification time input

saveSettings()
  - Validates and saves all settings

resetSettings()
  - Resets all settings to defaults

showStatus(message, type)
  - Displays status messages

validateNumericInput(value, min, max, defaultVal)
  - Validates numeric inputs with bounds checking

getSeparatorValue(optionValue)
  - Converts separator option to actual string

getSeparatorOption(separatorString)
  - Converts separator string to option value

renderDomainList()
  - Renders domain list from hidden input value
  - Each domain shows bookmark configuration button and bookmark info

createDomainListItem(domain, bookmarks)
  - Creates domain list item with name, bookmark config button, and remove button
  - Shows configured bookmark count and titles if any

isValidDomainPattern(domain)
  - Validates domain format for stopwatch filter
  - Allows: domain.com, *.domain.com, domain.*, *domain*
  - Rejects: empty, invalid characters, consecutive dots

addDomain(domain)
  - Adds domain to stopwatch filter list
  - Validates domain format before adding

removeDomain(domain)
  - Removes domain from stopwatch filter list

initializeDomainTagListeners()
  - Sets up domain input event handlers

loadProfileSettings()
  - Loads search profiles from storage

initializeProfileUI(profileNum)
  - Renders search pattern profile UI

saveProfileSettings()
  - Saves current profile patterns

resetProfileSettings()
  - Resets profile to defaults

selectAllProfile()
  - Selects all patterns in current profile

deselectAllProfile()
  - Deselects all patterns in current profile

initializeSidebarNavigation()
  - Sets up sidebar scroll tracking for active state

toggleBookmarkSettings(enabled)
  - Shows/hides bookmark toggle based on notification enabled state

toggleBookmarkSelector(enabled)
  - Shows/hides bookmark selector based on open bookmarks enabled state
  - Also calls toggleCustomBookmarkletsContainer()

toggleCustomBookmarkletsContainer(enabled)
  - Shows/hides custom bookmarklets container based on notification enabled state

loadGlobalBookmarkletsList() [async]
  - Loads custom bookmarklets from chrome.storage.local
  - Renders checklist with checkboxes for selecting global bookmarklets
  - Checks boxes for currently selected bookmarklets

getSelectedGlobalBookmarklets()
  - Returns array of checked bookmarklet IDs from global bookmarklet checklist
  - Called by saveSettings() to persist selections

parseBookmarksByDomain(value)
  - Parses JSON object mapping domains to bookmark arrays from hidden input

parseNotificationTimeByDomain(value)
  - Parses JSON object mapping domains to notification times (in seconds)
  - Returns empty object if invalid or empty

formatSecondsToMMSS(totalSeconds)
  - Formats seconds to MM:SS display format
  - Example: 671 -> "11:11", 300 -> "5:00"
  - Returns empty string if invalid

parseMMSSToSeconds(timeStr)
  - Parses MM:SS format or plain minutes to seconds
  - Example: "11:11" -> 671, "5:00" -> 300, "30" -> 1800
  - Returns null if invalid format

createDomainListItem(domain, bookmarks, notificationTimeSeconds)
  - Creates a domain list item with bookmark configuration button
  - Shows notification time (if set) and bookmark count
  - Displays time in MM:SS format (e.g., ⏰ 11:11)

openEditSiteModal(domain, bookmarks, notificationTimeSeconds)
  - Opens modal to configure bookmarks and notification time for a domain

openSiteBookmarkModal(domain, existingBookmarks, existingNotificationTime)
  - Modal for configuring bookmarks and notification time for a specific domain
  - Shows notification time input (MM:SS format), bookmark tree browser, and selected bookmarks preview
  - Notification time is stored in seconds

renderBookmarkNodeForSite(container, node, selectedIds, selectedBookmarks, depth, onSelectionChange)
  - Recursively renders bookmark folders and items in site configuration modal

--------------------------------------------------------------------------------
theme-manager.js - Centralized theme management
--------------------------------------------------------------------------------

isExtensionContextValid()
  - Checks if extension context is valid

loadTheme()
  - Loads theme from storage

applyThemeToDOM(theme)
  - Applies theme to document elements

initialize()
  - Initializes theme manager with message listeners

whenReady()
  - Returns promise that resolves when initialized

setTheme(theme)
  - Sets theme and notifies subscribers

getTheme()
  - Returns current theme name

getThemeColors(theme)
  - Returns color palette for theme

getDialogColorsForTheme(theme)
  - Returns dialog-specific colors

getDialogColors(buttonText)
  - Computes dialog colors based on button text

subscribe(callback)
  - Registers callback for theme changes

notifySubscribers(theme)
  - Notifies all subscribers of theme change

getAvailableThemes()
  - Returns list of all available themes

Available Themes: light, dark, catppuccin-mocha, cats, cat-night

--------------------------------------------------------------------------------
search.js - Multi-element search pattern generation
--------------------------------------------------------------------------------

loadDefaultSearchEngine()
  - Loads default search engine from settings

saveDefaultSearchEngine(engine)
  - Saves selected search engine

loadSearchFromUrl()
  - Loads search elements from URL parameters

getCombinations(elements, size)
  - Generates word combinations of specified size

getCurrentElements()
  - Gets all search input values

generateExampleQuery(pattern, exampleElements, wordCount)
  - Creates example query from pattern

getProfileSettings(profileNum)
  - Gets search patterns for profile

initializeProfileSettings(profileNum)
  - Renders profile pattern UI

selectAllInSection(profileNum, wordCount)
  - Selects all patterns in section

deselectAllInSection(profileNum, wordCount)
  - Deselects all patterns in section

updateSectionStatus(profileNum, wordCount)
  - Updates section status display

loadSettings()
  - Loads profile settings from storage

saveCurrentProfileSettings()
  - Saves current profile patterns

resetCurrentProfileSettings()
  - Resets profile to defaults

selectAllInCurrentProfile()
  - Selects all patterns in profile

deselectAllInCurrentProfile()
  - Deselects all patterns in profile

generateQueries(elements)
  - Generates all search queries from elements

getSearchUrl(query, engine)
  - Creates search URL for engine

updateSearchPreview()
  - Updates preview of generated queries

Search Engines: Google, YouTube, Google AI, Bing, DuckDuckGo

--------------------------------------------------------------------------------
settings-utils.js - Settings validation and migration
--------------------------------------------------------------------------------

isExtensionContextValid()
  - Checks if extension context is valid

validateCopyFormats(copyFormats)
  - Validates copy format settings object

validateSetting(key, value)
  - Validates individual setting by key

validateSettings(settings)
  - Validates all settings object

migrateSettings(settings)
  - Fills missing keys with defaults

loadSettings()
  - Loads all settings from storage

saveSetting(key, value)
  - Saves single setting with validation

saveSettings(settings)
  - Saves multiple settings with validation

getSetting(key)
  - Gets single setting value

getSettings(keys)
  - Gets multiple settings

resetSettings()
  - Clears all settings to defaults

getValidationRule(key)
  - Returns validation rules for setting

getDefaultSettings()
  - Returns copy of default settings

--------------------------------------------------------------------------------
comparison.js - Wikipedia/IMDb data comparison
--------------------------------------------------------------------------------

isExtensionContextValid()
  - Checks if extension context is valid

getCurrentPageInfo()
  - Extracts current page information (source, title, URL, imdbId)
  - Returns: object | null

selectComparisonTab(currentSource)
  - Opens tab selector modal for comparison
  - Parameters: currentSource (string) - 'wikipedia' or 'imdb'
  - Returns: Promise<tab object | null>

createTabSelectorModal(tabs, currentSource, callback)
  - Creates modal UI for tab selection
  - Parameters: tabs (array), currentSource (string), callback (function)

extractIMDbId(url)
  - Extracts IMDb title ID from URL
  - Parameters: url (string)
  - Returns: string | null

showComparisonStatus(message, type)
  - Creates and shows status notification
  - Parameters: message (string), type ('info'|'success'|'error')
  - Returns: HTMLElement

updateComparisonStatus(message, type)
  - Updates existing status notification
  - Parameters: message (string), type (string)

removeComparisonStatus()
  - Removes status notification with animation

setupComparisonProgressListener()
  - Sets up listener for comparison progress messages from background

initiateComparison(currentPageInfo)
  - Main function to start comparison workflow
  - Parameters: currentPageInfo (object)
  - Sends message to background script and handles progress

initComparisonButton()
  - Initializes "Compare with IMDb/Wikipedia" button on page
  - Respects user settings for button visibility

removeComparisonButton()
  - Removes comparison button from page

Features: Wikipedia-IMDb comparison, tab selection, conflict detection, progress notifications

--------------------------------------------------------------------------------
youtube-transcript-copy.js - YouTube transcript extraction
--------------------------------------------------------------------------------

isExtensionContextValid()
  - Checks if extension context is still valid

isYouTubeVideoPage()
  - Checks if current page is a YouTube video page

getVideoId()
  - Extracts video ID from URL parameters

getVideoTitle()
  - Extracts video title from page elements or meta tags

getThemeColors()
  - Gets theme colors for button styling

getCopyButtonSettings()
  - Loads transcript button visibility setting from storage

addTranscriptButton()
  - Creates and adds the transcript button to YouTube's action bar

waitForElement(selector, timeout)
  - Waits for DOM element to appear with timeout

decodeHTMLEntities(text)
  - Decodes HTML entities in text

stripTags(html)
  - Removes HTML tags from text

formatTimestamp(seconds)
  - Formats seconds to MM:SS or HH:MM:SS timestamp

getYtInitialPlayerResponse()
  - Extracts ytInitialPlayerResponse from page scripts

fetchTranscriptInnerTube(videoId)
  - Fetches transcript using YouTube's InnerTube API

fetchFromCaptionTracks(captionTracks)
  - Parses transcript from caption track XML

fetchTranscriptFromNextEndpoint(videoId)
  - Fetches transcript from /next endpoint (engagement panel)

findContinuationToken(content)
  - Finds continuation token in panel content

fetchTranscriptWithToken(token)
  - Fetches transcript using continuation token

fetchTranscriptFromPage(videoId)
  - Fallback method: fetches transcript from page HTML

extractTranscript()
  - Main extraction function, tries multiple methods

resetButton()
  - Resets button state after extraction

showNotification(message, isError)
  - Shows toast notification on page

initialize()
  - Initializes transcript button with SPA navigation handling

API Used: YouTube InnerTube API (player, next, get_transcript endpoints)
Caption Priority: English manual > English auto > Any auto > First available

--------------------------------------------------------------------------------
youtube-transcript-view.js - Transcript display page
--------------------------------------------------------------------------------

showToast(message, type)
  - Shows toast notification (success/error)

formatTime(seconds)
  - Formats seconds to MM:SS or HH:MM:SS

countWords(text)
  - Counts words in text string

escapeHtml(text)
  - Escapes HTML characters for safe display

highlightText(text, term)
  - Highlights search terms in text

loadTranscriptData()
  - Loads transcript data from chrome.storage.local

generateTranscriptText(withTimestamps)
  - Generates formatted transcript text for copying

generatePlainText()
  - Generates plain text with all segments joined

renderTranscript()
  - Main render function for transcript view

renderSegments()
  - Renders transcript segments with optional timestamps

copyTranscript()
  - Copies transcript to clipboard (with/without timestamps)

downloadTranscript()
  - Downloads transcript as .txt file

toggleTimestamps()
  - Toggles timestamp visibility

handleSearch(e)
  - Handles search input with filtering

initializeEventListeners()
  - Sets up all event listeners

Keyboard Shortcuts:
  - Ctrl/Cmd + C: Copy transcript (when not in input)
  - Ctrl/Cmd + S: Download transcript
  - Ctrl/Cmd + F: Focus search box

Features: Timestamp toggle, search/filter, copy, download, click-to-copy timestamps

--------------------------------------------------------------------------------
youtube-transcript-view.html - Transcript viewer page
--------------------------------------------------------------------------------

UI Components:
  - Header with video title and metadata
  - Transcript controls (timestamp toggle, copy, download buttons)
  - Statistics section (segments, words, duration)
  - Search box with live filtering
  - Transcript segments with clickable timestamps
  - Plain text view (hidden by default)

Theme Support: Uses CSS variables from theme-manager.js
Styles: Responsive layout, hover effects, toast notifications

================================================================================
UTILITY FILES
================================================================================

--------------------------------------------------------------------------------
date-formatting-utils.js - Shared date utilities
--------------------------------------------------------------------------------

parseDate(dateString)
  - Parses dates in multiple formats to Date object

findMonthIndex(monthStr)
  - Finds month index from month name

formatDate(date, format)
  - Formats Date object to string

parseAndFormat(dateString, outputFormat)
  - Parses and reformats date in one step

looksLikeDate(str)
  - Detects if string contains a date

getUserDateFormat()
  - Gets user's preferred date format from settings

extractYear(str)
  - Extracts year from string

Supported Formats: DD MMM YYYY, YYYY-MM-DD, MM/DD/YYYY, DD/MM/YYYY, MMM DD YYYY

--------------------------------------------------------------------------------
customized-views.js - Reusable view components
--------------------------------------------------------------------------------

CustomizedView Class:
  constructor(options)
    - Initializes view with data and options

  setupDropdownCleanupObserver()
    - Sets up DOM observers for cleanup

  destroy()
    - Cleans up listeners and observers

  getAvailableRoles()
    - Gets unique roles in data

  render()
    - Renders sortable table view

  setupCopyDropdown(cell, columnName)
    - Creates copy dropdown menu

  setupRoleFilter()
    - Creates role filter UI

  setupSearch()
    - Creates search input

  handleCopy(text)
    - Copies text to clipboard

Features: Sortable tables, searchable data, role filtering, copy-to-clipboard

================================================================================
PLATFORM-SPECIFIC CAST COPY SCRIPTS
================================================================================

imdb-cast-copy.js
wiki-cast-copy.js
letterboxd-cast-copy.js
appletv-cast-copy.js
airtelxstream-cast-copy.js
bookmyshow-copy.js

Common Functions:
  extractCastData()
    - Scrapes cast information from page

  formatCastOutput(format)
    - Formats data based on user preference

  copyCastToClipboard()
    - Copies formatted cast list

================================================================================
ADDITIONAL FILES
================================================================================

offscreen.js
  - Offscreen document for OCR processing (Tesseract.js)

hotstar-auto-view-more.js
  - Auto-expanding content on Hotstar

hotstar-episode-copy.js / hotstar-show-title-copy.js
  - Hotstar-specific data extraction

imdb-customized-views.js / wiki-customized-views.js / appletv-customized-views.js
  - Platform-specific customized view implementations

consolidated-view-page.js
  - Dedicated view page for consolidated IMDb data

comparison-view-page.js
  - Dedicated view page for Wikipedia/IMDb comparisons

cbfc-ocr.js / cbfc-fix.js
  - CBFC certificate OCR and processing

youtube-transcript-copy.js / youtube-transcript-view.js / youtube-transcript-view.html
  - YouTube transcript extraction and viewing system

================================================================================
CONSTANTS & CONFIGURATIONS
================================================================================

groupingPatterns (background.js)
  - Patterns for 1-4 word grouping combinations
  - Example: 2 words can be "word1 | word2" or "word1-word2"

patternDescriptions (background.js, settings.js, search.js)
  - Search pattern templates for each word count (1-4)
  - Templates: plain, quoted, intitle, allintitle, intext, phrase, and/or

defaultPatterns (background.js, settings.js, search.js)
  - Default enabled patterns per word count

themeColors/themeColorPalettes (theme-manager.js, stopwatch.js)
  - Color definitions for themes:
    - light: Default web colors
    - dark: Dark mode
    - catppuccin-mocha: Community theme
    - cats: Custom cat-themed
    - cat-night: Dark cat theme

DEFAULT_SETTINGS (settings-utils.js)
  - All default extension settings (50+ settings)
  - Includes stopwatchOpenBookmarksOnNotification (boolean, default: false)
  - Includes stopwatchBookmarksByDomain (object mapping domains to bookmark arrays)
  - Includes stopwatchNotificationTimeByDomain (object mapping domains to time in seconds)
    - Per-domain notification times, format: { "youtube.com": 671, "twitter.com": 300 }
    - Time is stored in seconds (e.g., 671 = 11 minutes 11 seconds)
    - Falls back to stopwatchNotificationMinutes * 60 if not set for domain
  - Includes stopwatchGlobalBookmarklets (array of bookmarklet IDs)
    - Custom bookmarklets that run on ALL domains when timer expires
    - Format: ["bm_1234_abc", "bm_5678_def"]

VALIDATION_RULES (settings-utils.js)
  - Type and constraint validation for all settings
  - Supports: string, number, boolean, array, object types
  - Validates: enums, min/max values

INNERTUBE_API_KEY, INNERTUBE_CLIENT_VERSION (youtube-transcript-copy.js)
  - YouTube InnerTube API configuration for transcript extraction

Queue Constants (background.js)
  - MAX_PENDING_UPDATES: 50 (prevents unbounded growth)
  - UPDATE_TIMEOUT: 5 minutes (auto-clean old updates)

================================================================================
ARCHITECTURE NOTES
================================================================================

Message Flow:
1. Content scripts detect user actions (selection, clicks)
2. Messages sent to background.js for processing
3. Background coordinates tab operations and data extraction
4. Results returned to content scripts or stored
5. Theme changes broadcast to all scripts
6. Settings changes automatically sync across extension

Storage:
- chrome.storage.sync: User settings (limited to 100KB)
- chrome.storage.local: Temporary data (YouTube transcripts, comparison data)
- SettingsUtils: Handles validation, migration, and defaults
- ThemeManager: Centralized theme state with subscriber pattern

Key Patterns:
- Profile-based search patterns (1-4 word combinations)
- Multiple date formats supported
- Theme system with 5 themes and subscriber notifications
- Domain filtering with wildcard support (*.example.com, *keyword*)
- Format options for cast/crew copying (newline, comma, CSV, JSON, table)
- YouTube transcript extraction via InnerTube API
- UUID-based storage keys prevent concurrent operation conflicts

Extension Context Safety:
- All scripts check isExtensionContextValid() before chrome API calls
- Graceful degradation when context is invalidated
- Try-finally blocks ensure cleanup of storage keys

Tab Management:
- Staggered tab opening (300ms intervals) prevents rate limiting
- Polling mechanism for data extraction (500ms checks, max 60 seconds)
- Automatic tab cleanup after extraction

Security Measures:
- textContent preferred over innerHTML for user data
- Safe string replacement (split-join instead of regex with user input)
- Tab ID validation before processing
- Context menu text sanitization (50 char limit, special chars removed)

================================================================================
